<!DOCTYPE html>
<html>
<head>
    <title>Candlestick Test Workflow</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #test-steps { margin-bottom: 20px; }
        .step { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        #chart-container { width: 800px; height: 400px; border: 1px solid #ddd; margin: 20px 0; }
        .log { background: #f5f5f5; padding: 5px; margin: 5px 0; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <h2>Candlestick Chart Test Workflow</h2>
    
    <div id="test-steps">
        <div class="step">
            <h3>Step 1: Test API Connection</h3>
            <button onclick="testAPI()">Test API</button>
            <div id="api-result"></div>
        </div>
        
        <div class="step">
            <h3>Step 2: Test ECharts Basic Functionality</h3>
            <button onclick="testBasicChart()">Test Basic Chart</button>
        </div>
        
        <div class="step">
            <h3>Step 3: Test Candlestick Rendering</h3>
            <button onclick="testCandlestickChart()">Test Candlestick</button>
        </div>
    </div>
    
    <div id="chart-container"></div>
    
    <div id="logs">
        <h4>Debug Logs:</h4>
    </div>

    <script>
        let chart = null;
        
        function log(message) {
            const logs = document.getElementById('logs');
            const logDiv = document.createElement('div');
            logDiv.className = 'log';
            logDiv.textContent = new Date().toISOString() + ': ' + message;
            logs.appendChild(logDiv);
            console.log(message);
        }
        
        async function testAPI() {
            try {
                log('Testing API connection...');
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbols: ['^AORD'],
                        chart_type: 'candlestick',
                        interval_minutes: 60,
                        time_period: '24h'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                log(`API Success: Got ${data.data['^AORD']?.length || 0} data points`);
                
                if (data.data['^AORD']?.length > 0) {
                    const firstPoint = data.data['^AORD'][0];
                    log(`Sample data: market_open=${firstPoint.market_open}, OHLC=[${firstPoint.open}, ${firstPoint.close}, ${firstPoint.low}, ${firstPoint.high}]`);
                    
                    document.getElementById('api-result').innerHTML = 
                        `<pre>${JSON.stringify(data.data['^AORD'].slice(0, 3), null, 2)}</pre>`;
                }
                
                window.testData = data.data['^AORD']; // Store for next test
                
            } catch (error) {
                log(`API Error: ${error.message}`);
                document.getElementById('api-result').innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }
        
        function testBasicChart() {
            try {
                log('Testing basic ECharts initialization...');
                
                if (chart) {
                    chart.dispose();
                }
                
                chart = echarts.init(document.getElementById('chart-container'));
                
                const option = {
                    title: { text: 'Basic Test Chart' },
                    xAxis: { type: 'category', data: ['A', 'B', 'C', 'D', 'E'] },
                    yAxis: { type: 'value' },
                    series: [{
                        name: 'Test',
                        type: 'line',
                        data: [1, 3, 2, 4, 5]
                    }]
                };
                
                chart.setOption(option);
                log('Basic chart rendered successfully');
                
            } catch (error) {
                log(`Basic chart error: ${error.message}`);
            }
        }
        
        function testCandlestickChart() {
            try {
                log('Testing candlestick chart rendering...');
                
                if (!window.testData) {
                    log('No test data available. Please run API test first.');
                    return;
                }
                
                if (chart) {
                    chart.dispose();
                }
                
                chart = echarts.init(document.getElementById('chart-container'));
                
                // Convert API data to ECharts format
                const candlestickData = [];
                const xAxisData = [];
                
                window.testData.slice(0, 20).forEach((point, index) => {
                    if (point.market_open && point.open !== null && point.high !== null && 
                        point.low !== null && point.close !== null) {
                        
                        // ECharts expects [open, close, low, high]
                        const ohlc = [point.open, point.close, point.low, point.high];
                        candlestickData.push(ohlc);
                        
                        // Create time label
                        const time = new Date(point.timestamp);
                        xAxisData.push(time.toISOString().substring(11, 16)); // HH:MM format
                    }
                });
                
                log(`Prepared ${candlestickData.length} candlestick data points`);
                log(`Sample candlestick data: ${JSON.stringify(candlestickData.slice(0, 2))}`);
                
                const option = {
                    title: {
                        text: 'Candlestick Chart Test - ^AORD'
                    },
                    xAxis: {
                        type: 'category',
                        data: xAxisData
                    },
                    yAxis: {
                        type: 'value',
                        axisLabel: {
                            formatter: '{value}%'
                        }
                    },
                    series: [{
                        name: '^AORD',
                        type: 'candlestick',
                        data: candlestickData,
                        itemStyle: {
                            color: '#00da3c',      // Bull candle
                            color0: '#ec0000',     // Bear candle  
                            borderColor: '#00da3c', // Bull border
                            borderColor0: '#ec0000' // Bear border
                        }
                    }]
                };
                
                chart.setOption(option);
                log('Candlestick chart rendered successfully');
                
            } catch (error) {
                log(`Candlestick chart error: ${error.message}`);
                console.error('Detailed error:', error);
            }
        }
        
        // Initialize
        log('Test page loaded');
    </script>
</body>
</html>