<!DOCTYPE html>
<html>
<head>
    <title>Test Market Lines</title>
</head>
<body>
    <script>
        // Test the frontend analysis
        async function testAnalysis() {
            const response = await fetch('http://localhost:8000/api/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    symbols: ['^N225', '^AXJO'],
                    chart_type: 'percentage',
                    interval_minutes: 5,
                    time_period: '24h'
                })
            });
            
            const data = await response.json();
            
            // Simulate the frontend market line logic
            const symbolInfos = {
                '^N225': { market: 'Japan' },
                '^AXJO': { market: 'Australia' }
            };
            
            Object.entries(data.data).forEach(([symbol, points]) => {
                const symbolInfo = symbolInfos[symbol];
                if (!symbolInfo) return;
                
                // Market close times logic (copy from frontend)
                const marketCloseTimes = {
                    'Japan': { hour: 16, minute: 30 },
                    'Australia': { hour: 16, minute: 0 }
                };
                
                // Filter future data
                const now = new Date();
                const validPoints = points.filter((point) => {
                    const timestampStr = point.timestamp.replace(' AEST', '');
                    const pointTime = new Date(timestampStr);
                    return pointTime <= now;
                });
                
                console.log(`=== ${symbol} (${symbolInfo.market}) ===`);
                console.log(`Total points: ${points.length}, Valid points: ${validPoints.length}`);
                
                if (marketCloseTimes[symbolInfo.market]) {
                    const targetClose = marketCloseTimes[symbolInfo.market];
                    let closestIndex = -1;
                    let minTimeDiff = Infinity;
                    
                    console.log(`Looking for close time at ${targetClose.hour}:${targetClose.minute.toString().padStart(2, '0')} AEST`);
                    
                    validPoints.forEach((point, index) => {
                        const timestampStr = point.timestamp.replace(' AEST', '');
                        const pointTime = new Date(timestampStr);
                        const pointHour = pointTime.getHours();
                        const pointMinute = pointTime.getMinutes();
                        
                        // Calculate time difference in minutes
                        const targetTotalMinutes = targetClose.hour * 60 + targetClose.minute;
                        const pointTotalMinutes = pointHour * 60 + pointMinute;
                        const timeDiff = Math.abs(pointTotalMinutes - targetTotalMinutes);
                        
                        if (timeDiff < minTimeDiff) {
                            minTimeDiff = timeDiff;
                            closestIndex = index;
                        }
                    });
                    
                    if (closestIndex !== -1) {
                        console.log(`Closest match: ${validPoints[closestIndex].timestamp} (index ${closestIndex}, diff: ${minTimeDiff} minutes)`);
                    }
                }
                console.log('');
            });
        }
        
        // Run test after page loads
        window.onload = () => {
            testAnalysis().catch(console.error);
        };
    </script>
</body>
</html>